// This file is generated by FBC.

#include "Controller.h"
#include <string.h>
#include <stdio.h>

/* Function block initialization function */
void Controllerinit(Controller* me)
{
    me->_state = 0;
    me->_entered = false;
    me->_input.events = 0;
    me->_output.events = 0;
}

/* ECC algorithms */
void Controller_AdjustSetPoint(Controller* me)
{
//me->sp = 6.75 + 7.91 * tanh(0.13 * (me->distance - 5) - 1.57);


}

void Controller_DEC(Controller* me)
{
//printf("Signal sent : the following car decelerates |  Speed1: %3.8f, Speed2: %3.8f, Distance: %3.8f\n", me->speed1, me->speed2, me->distance);
//printf("decelerate Speed1 %3.8f Speed2 %3.8f Distance %3.8f\n", me->speed1, me->speed2, me->distance);
}

void Controller_ACC(Controller* me)
{
//printf("Signal sent : the following car accelerates |  Speed1: %3.8f, Speed2: %3.8f, Distance: %3.8f\n", me->speed1, me->speed2, me->distance);
//printf("accelerate Speed1 %3.8f Speed2 %3.8f Distance %3.8f\n", me->speed1, me->speed2, me->distance);
}

/* Function block execution function */
void Controllerrun(Controller* me)
{
    me->_output.events = 0;

    if (me->_input.event.Update) {
        me->speed2 = me->_speed2;
        me->distance = me->_distance;
        me->speed1 = me->_speed1;
    }
    for (;;) {
        switch (me->_state) {
            case 0:
                // State: Start
                if (!me->_entered) {
                    me->_entered = true;
                }
                else {
                    me->_state = 1;
                    me->_entered = false;
                    continue;
                }
                break;
            case 1:
                // State: State1
                if (!me->_entered) {
                    Controller_ACC(me);
                    me->_output.event.ACC = 1;
                    me->_entered = true;
                }
                else {
                    if (me->speed2 >= 11.62 && me->speed1 == 0) {
                        me->_state = 2;
                        me->_entered = false;
                        continue;
                    }
                    else if (me->speed2 <= 3.37 && me->speed1 == 14.66) {
                        me->_state = 3;
                        me->_entered = false;
                        continue;
                    }
                }
                break;
            case 2:
                // State: State2
                if (!me->_entered) {
                    Controller_DEC(me);
                    me->_output.event.DEC = 1;
                    me->_entered = true;
                }
                else {
                    if (me->speed2 <= 3.37 && me->speed1 == 14.66) {
                        me->_state = 3;
                        me->_entered = false;
                        continue;
                    }
                }
                break;
            case 3:
                // State: State3
                if (!me->_entered) {
                    Controller_ACC(me);
                    me->_output.event.ACC = 1;
                    me->_entered = true;
                }
                else {
                    if (me->speed2 >= 11.62 && me->speed1 == 0) {
                        me->_state = 2;
                        me->_entered = false;
                        continue;
                    }
                }
                break;
        }
        break;
    }

    me->_input.events = 0;
}

