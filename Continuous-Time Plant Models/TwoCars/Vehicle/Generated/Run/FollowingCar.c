// This file is generated by FBC.

#include "FollowingCar.h"
#include <string.h>
#include <stdio.h>

/* Function block initialization function */
void FollowingCarinit(FollowingCar* me)
{
    me->_state = 0;
    me->_entered = false;
    me->_input.events = 0;
    me->_output.events = 0;
    me->pos2 = 0;
    me->_pos2 = 0;
    me->speed2 = 13.8;
    me->_speed2 = 13.8;
}

/* ECC algorithms */
void FollowingCar_Init(FollowingCar* me)
{
me->d = 0.01;
//me->v = 13.8;
me->speed2 = 13.8;
me->x = 0;
me->k = 366;
me->isInitial = true;
}

void FollowingCar_Decelerate(FollowingCar* me)
{
me->v = me->speed2;
me->x = me->pos2;

//me->v = CarFollow_ode_1(C1v, d, k, s, x);
me->speed2 = me->v + me->d * 0.85 * (6.75 + 7.91 * tanh(0.13 * (me->distance - 5) - 1.57) - me->v);
me->pos2 = me->x + me->d * me->v;

printf("Following car decelerates (Position: %3.8f, Speed: %3.8f, Distance: %3.8f)\n", me->pos2, me->speed2, me->distance);
}

void FollowingCar_Accelerate(FollowingCar* me)
{
me->v = me->speed2;
me->x = me->pos2;

//me->v = CarFollow_ode_1(C1v, d, k, s, x);
me->speed2 = me->v + me->d * 0.85 * (6.75 + 7.91 * tanh(0.13 * (me->distance - 5) - 1.57) - me->v);
me->pos2 = me->x + me->d * me->v;

printf("Following car accelerates (Position: %3.8f, Speed: %3.8f, Distance: %3.8f)\n", me->pos2, me->speed2, me->distance);
}

void FollowingCar_Reset(FollowingCar* me)
{
if(!me->isInitial){
  me->k = 1;
}
}

void FollowingCar_Init_Acc(FollowingCar* me)
{
me->max=false;
if(me->isInitial==false){
me->k = 0;
}
}

void FollowingCar_Init_Dec(FollowingCar* me)
{
me->min=false;
if(me->isInitial==false){
me->k = 38;
}
}

/* Function block execution function */
void FollowingCarrun(FollowingCar* me)
{
    me->_output.events = 0;

    if (me->_input.events) {
        if (me->_input.event.FrontLaserSensor) {
            me->distance = me->_distance;
        }
    }
    for (;;) {
        switch (me->_state) {
            case 0:
                // State: Start
                if (!me->_entered) {
                    FollowingCar_Init(me);
                    me->_entered = true;
                }
                else {
                    me->_state = 1;
                    me->_entered = false;
                    continue;
                }
                break;
            case 1:
                // State: State1
                if (!me->_entered) {
                    me->_entered = true;
                }
                else {
                    if (me->_input.event.DEC) {
                        me->_state = 2;
                        me->_entered = false;
                        continue;
                    }
                    else if (me->_input.event.ACC) {
                        me->_state = 3;
                        me->_entered = false;
                        continue;
                    }
                }
                break;
            case 2:
                // State: State2
                if (!me->_entered) {
                    FollowingCar_Decelerate(me);
                    me->_output.event.Update = 1;
                    me->_entered = true;
                }
                else {
                    if (me->_input.event.ACC) {
                        me->_state = 3;
                        me->_entered = false;
                        continue;
                    }
                    else if (me->_input.event.DEC) {
                        me->_state = 2;
                        me->_entered = false;
                        continue;
                    }
                }
                break;
            case 3:
                // State: State3
                if (!me->_entered) {
                    FollowingCar_Accelerate(me);
                    me->_output.event.Update = 1;
                    me->_entered = true;
                }
                else {
                    if (me->_input.event.DEC) {
                        me->_state = 2;
                        me->_entered = false;
                        continue;
                    }
                    else if (me->_input.event.ACC) {
                        me->_state = 3;
                        me->_entered = false;
                        continue;
                    }
                }
                break;
        }
        break;
    }
    if (me->_output.event.Update) {
        me->_pos2 = me->pos2;
        me->_speed2 = me->speed2;
    }

    me->_input.events = 0;
}

